# 测试指南

当各位遇到需要排除硬件功能是否正常的情况时，可参考本文档

## mic&audio测试

**硬件连接检查**

1.确认喇叭正确连接在开发板上标有`SPK`位置处的接口

2.检查是否因电池连接松动导致的供电不足

**软件测试**

1.创建test.py文件

2.插入测试demo

```python
import audio
import _thread
import utime


rec = audio.Record(0)
pcm = audio.Audio.PCM(0, 1, 16000, 2, 1)

pcm.setVolume(10)

def kws_cb(para):
    print("kws cb:", para)
# 唤醒词
list = ["_xiao_zhi_xiao_zhi","_xiao_mu_xiao_mu","_xiao_yuan_xiao_yuan"]

rec.ovkws_set_callback(kws_cb)
rec.ovkws_start(list, 0.7, 1)
def pcm_fun_test(para):
    while True:
        pcm_buf = pcm.read(640)
        if(len(pcm_buf) > 0):
            write_len = pcm.write(pcm_buf)
            #print("1l:", write_len)
            utime.sleep_ms(20)

def fun_start(func):
    _thread.start_new_thread(func, (1,))


fun_start(pcm_fun_test)

```

3.在QPYcom中运行test.py，运行成功后，当对mic说话，喇叭发出自己的声音则说明收音与喇叭功能正常。

4.需要单独测试时可参考：[录音API](https://developer.quectel.com/doc/quecpython/API_reference/zh/medialib/audio.Record.html)，[播音API](https://developer.quectel.com/doc/quecpython/API_reference/zh/medialib/audio.Audio.html)



## VAD检测

运行结果：检测到人声时会打印1，人声结束后打印0

```python

import Opus
import audio
import utime
from machine import Pin
from usr.logging import getLogger
import osTimer



logger = getLogger(__name__)
volume = 5
# ==================== 音频管理 ====================

class AudioManager(object):

    def __init__(self, channel=0, volume=5, pa_number=29):
        self.aud = audio.Audio(channel)  # 初始化音频播放通道
        self.aud.set_pa(pa_number)
        self.aud.setVolume(volume)  # 设置音量
        self.aud.setCallback(self.audio_cb)
        self.rec = audio.Record(channel)
        self.rec.gain_set(4,9)
        self.__skip = 0

    def setvolume_down(self):
        global volume
        volume -= 1
        if volume < 0: volume = 0
        self.aud.setVolume(volume)
        return volume
        
    def setvolume_up(self):
        global volume
        volume += 1
        if volume > 11: volume = 11
        self.aud.setVolume(volume)
        return volume
    
    def setvolume_close(self):
        self.aud.setVolume(0)
        volume = 0
        return volume

    # ========== 音频文件 ====================

    def audio_cb(self, event):
        if event == 0:
            # logger.info('audio play start.')
            pass
        elif event == 7:
            # logger.info('audio play finish.')
            pass
        else:
            pass

    def play(self, file):
        self.aud.play(0, 1, file)
        
    def stop(self):
        return self.aud.stopAll()
    # ========= opus ====================

    def open_opus(self):
        self.pcm = audio.Audio.PCM(0, 1, 16000, 2, 1, 15)  # 5 -> 25
        self.opus = Opus(self.pcm, 0, 6000)  # 6000 ~ 128000
    
    def close_opus(self):
        self.opus.close()
        self.pcm.close()
        del self.opus
        del self.pcm
    
    def opus_read(self):
        return self.opus.read(60)

    def opus_write(self, data):
        return self.opus.write(data)      
    # ========= vad & kws ====================

    def set_kws_cb(self, cb):
        self.rec.ovkws_set_callback(cb)

            
    def set_vad_cb(self, cb):
        def wrapper(state):
            # if self.__skip != 2:
            #     self.__skip += 1
            #     return
            return cb(state)
        self.rec.vad_set_callback(wrapper)

    def end_cb(self, para):
        if(para[0] == "stream"):
            if(para[2] == 1):
                pass
            elif (para[2] == 3):
                pass
            else:
                pass
        else:
            pass
    def start_kws(self):
        list=["_xiao_zhi_xiao_zhi","_xiao_tian_xiao_tian"]
        self.rec.ovkws_start("_xiao_zhi_xiao_zhi", 0.7)
 

    def stop_kws(self):
        self.rec.ovkws_stop()
    
    def start_vad(self):
        self.__skip = 0
        self.rec.vad_start()
    
    def stop_vad(self):
        self.rec.vad_stop()


def vad_callback(state):
    print("VAD状态变化:", state)
    # state == 1 表示检测到有人声，0 表示无人声 
    
def main():
    audio_manager = AudioManager()
    audio_manager.set_vad_cb(vad_callback)
    audio_manager.open_opus()
    audio_manager.start_vad()
    print("开始VAD测试，按Ctrl+C退出")
    x=2
    try:
        while True:
            audio_manager.opus_read()
            utime.sleep_ms(10)
    except KeyboardInterrupt:
        print("测试结束")
        audio_manager.stop_vad()
        audio_manager.close_opus()

if __name__ == "__main__":    
    main()    
```



## LCD测试

**硬件连接检查**

1.确认LCD模块与开发板正确连接

2.检查是否因电池连接松动导致的供电不足

**软件测试**

可参考[LCD显示屏](.././text_demo/LCD_text)